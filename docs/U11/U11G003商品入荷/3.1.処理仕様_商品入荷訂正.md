# 商品入荷訂正処理仕様

***

## 商品入荷訂正登録

- 商品入荷登録後、翌営業日以降に商品入荷を訂正する。
- 新たに$商品入荷訂正を登録する。
    - 入荷数を1つ減らす場合、「入荷日=訂正する営業日」「移動数=-1」の商品移動を登録する。
    - 前日営業日までに登録した内容を更新しない。
- 訂正後の翌日以降に再度訂正する場合は、新たに$商品入荷訂正を登録する。
    - $商品入荷訂正が2件以上となる。

### データ存在検証

エラー条件

- 画面.明細リスト_入荷-:商品コード:-商品が存在しない

### 商品移動入荷訂正の構築

- 部署=$商品入荷.部署
- 日付=$商品入荷.部署.営業日
- 区分=入荷訂正
- タイムスタンプ=現在日付時刻
- 商品移動明細リスト
    - 明細番号、商品、移動数=下記参照

#### 既存の$商品入荷の入荷数を訂正する場合

たとえば1/1で商品Aを5つ入荷し、（明細番号=1、商品移動数=5とする）、1/2これを6に訂正する場合

- 明細番号=1
- 商品=商品A
- 移動数=+1

#### 既存の$商品入荷を取り消す（入荷数=0）とする場合

たとえば1/1で商品Aを5つ入荷し（明細番号=1、商品移動数=5とする）、1/2にその入荷をなかったことにする場合

- 明細番号=1
- 商品=商品A
- 移動数=-5

#### 新たな商品の入荷を登録する場合

たとえば1/1で商品Aを入荷登録せず、1/2に改めてこれを5つ入荷とした場合

- 明細番号=既存の明細番号の最大値+1（以降同様に採番)
- 商品=商品A
- 移動数=5

### 処理可否検証

- 下記参照

### $商品入荷の訂正登録時整合性検証

エラー条件

- 入荷登録してからまだ営業日が更新されていない（締前）
    - $商品入荷.入荷日 = $商品入荷.部署.営業日
- 入荷日以降に棚卸を実施済
    - [商品棚卸済](/U11/仕様/商品棚卸済)
- 商品移動の更新の結果、商品の在庫数がマイナスになる
    - [マイナス商品在庫](/u11/仕様/マイナス商品在庫)

### $商品入荷訂正の保存

- 商品移動テーブル
- 商品移動明細テーブル
- 商品入荷訂正テーブル

***

## 商品入荷訂正更新

- 入荷訂正登録後、再度この登録内容を更新する。

### データ存在検証

エラー条件

- 画面.明細リスト_入荷-:商品コード:-商品が存在しない

### 商品移動入荷訂正の構築

同上

### 処理可否検証

- 下記参照

### $商品入荷の訂正更新時整合性検証

エラー条件

- 当日営業日に入荷訂正を行っていない。
    - 下記条件を満たさない
    - $商品入荷.部署.営業日 ∈ $商品入荷.訂正商品リスト:-商品移動.移動日
- 商品移動の更新の結果、商品の在庫数がマイナスになる
    - [マイナス商品在庫](/u11/仕様/マイナス商品在庫)

### $商品入荷訂正の保存

同上

***

## 商品入荷訂正削除

- 入荷訂正登録後、その登録内容を削除する。

### 処理可否検証

- 下記参照

### $商品入荷の訂正削除時整合性検証

エラー条件

- 当日営業日に入荷訂正を行っていない。
    - 下記条件を満たさない
    - $商品入荷.部署.営業日 ∈ $商品入荷.訂正商品リスト:-商品移動.移動日

### $商品入荷訂正の削除

- 商品移動テーブル
- 商品移動明細テーブル
- 商品入荷訂正テーブル

***

## 処理可否検証

### 排他制御

- $商品入荷.部署が棚卸中の場合エラー
    - [商品棚卸中](/U11/仕様/商品棚卸中)

### ユーザー権限チェック

- $商品入荷.部署がユーザーの部署と異なる場合エラー
    - ユーザー:-社員.所属部署 != $商品入荷.部署
