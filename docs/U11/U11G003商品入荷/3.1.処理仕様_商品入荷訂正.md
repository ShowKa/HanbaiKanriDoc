# 商品入荷訂正処理仕様

***

## 商品入荷訂正登録

- 商品入荷登録後、翌営業日以降に商品入荷を訂正する。
- 新たに$商品入荷訂正を登録する。
    - 入荷数を1つ減らす場合、「入荷日=訂正する営業日」「移動数=-1」の商品移動を登録する。
    - 前日営業日までに登録した内容を更新しない。
- 訂正後の翌日以降に再度訂正する場合は、新たに$商品入荷訂正を登録する。
    - $商品入荷訂正が2件以上となる。

### 商品移動入荷訂正の構築

- 部署=$商品入荷.部署
- 日付=$商品入荷.部署.営業日
- 区分=入荷訂正
- タイムスタンプ=現在日付時刻
- 商品移動明細リスト
    - 明細番号=下記参照
    - 商品=下記参照
    - 移動数=下記参照

#### 既存の$商品入荷の入荷数を訂正する場合

たとえば1/1で商品Aを5つ入荷し、（明細番号=1、商品移動数=5とする）、1/2これを6に訂正する場合

- 明細番号=1
- 商品=商品A
- 移動数=+1

#### 既存の$商品入荷を取り消す（入荷数=0）とする場合

たとえば1/1で商品Aを5つ入荷し、（明細番号=1、商品移動数=5とする）、1/2これを削除した場合

- 明細番号=1
- 商品=商品A
- 移動数=-5

#### 新たな商品の入荷を登録する場合

たとえば1/1で商品Aを入荷登録せず、1/2にこれを5つに入荷訂正した場合

- 明細番号=既存の明細番号+1（以降同様に採番)
- 商品=商品A
- 移動数=5

### 処理可否検証

- 下記参照

### $商品入荷の訂正登録時整合性検証

エラー条件

- 入荷登録してからまだ営業日が更新されていない（締前）
    - $商品入荷.入荷日 = $商品入荷.部署:-営業日
- 入荷日以降に棚卸を実施済
    - [商品棚卸済](/U11/仕様/商品棚卸済)
- 商品移動の更新の結果、商品の在庫数がマイナスになる
    - [マイナス商品在庫](/u11/仕様/マイナス商品在庫)

### $商品入荷訂正の登録

- 商品移動テーブル
- 商品移動明細テーブル
- 商品入荷訂正テーブル

***

## 商品入荷訂正更新

- 商品入荷訂正登録後、当日営業日のうちに商品入荷訂正を修正し、更新する。
    - 訂正内容が間違っていたのでそれを修正する。

基本的に登録と同じなので記載省略。

***

## 商品入荷訂正削除

### 処理可否検証

- 下記参照

### $商品入荷の訂正削除時整合性検証

- XXX不要? $商品入荷訂正済ではない場合、エラー

### $商品入荷訂正の削除

#### $商品移動の整合性検証

- [マイナス商品在庫](/U11/仕様/マイナス商品在庫)となる場合、エラー

#### テーブルレコードの削除

- 商品移動テーブル
- 商品移動明細テーブル
- 商品入荷訂正テーブル

***

## 処理可否検証

### 排他制御

- $商品入荷.部署が棚卸中の場合エラー
    - [商品棚卸中](/U11/仕様/商品棚卸中)

### ユーザー権限チェック

- $商品入荷.部署がユーザーの部署と異なる場合エラー
    - ユーザー:-社員.所属部署 != $商品入荷.部署
