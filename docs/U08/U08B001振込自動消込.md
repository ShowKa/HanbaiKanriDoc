# [u08004] 振込から自動で債権（請求済み売掛等）を消込する。

- 理由：膨大の振込の消込に要する時間の削減

## U08B000 ワークテーブルの不要データ削除

- 不要なデータをワークテーブルから削除する。
	- 理由：データ蓄積による性能劣化を防止するため。
- ワークテーブル = FB振込と請求をマッチングし、自動消込するまでに使用する一時的なデータ保管用テーブル

### FB振込マッチングTable 削除

### FB振込マッチングエラーTable 削除

### 振分Table 削除

## U08B001 FB振込登録

FB振込ファイルのデータをFB振込Table に登録

詳細仕様

- 入力：ファイルパス
- データ更新方針:エラーデータはログファイルに出力し、登録できるものだけ登録する。
- トランザクション単位:一括
- 前提条件：なし

### 入力.ファイルパスから $[FB振込File](rescouce/****) 取得
FileManager#get

### $FB振込File から$読込不可能データリストを読込
CsvReader#getError

### $読込不可能データリストを[FB振込読込不可能データリスト](log/****) Fileとして出力
CsvWriter#write

### $FB振込File から読込可能行を $FB振込リスト として読込
CsvReader#readOnlyReadable

### $FB振込リスト をFB振込Table に登録
TFirmBankFurikomiRepository#save

## U08B002 振分登録

- FB振込と請求済み売掛をマッチングするための振分Table にデータを作成する。
	- 理由：請求と売掛はデータ量が膨大なので、必要なデータだけを専用の振分テーブルに登録する必要があるため。

詳細仕様

- 入力：部署コード
- データ更新方針:特記事項なし
- トランザクション単位:一括
- 前提条件：特記事項なし

### 請求Table から$請求リストを検索
SeikyuSearchService#getAllOf(入力.部署)

- 未完済である。つまり請求対象の売掛に残高がある。
- 有効である。つまり貸し倒れではない。
- 請求担当部署 = 入力.部署

### $請求を振分Table に登録
FirmBankFuriwakeCrudService#save

- 振込依頼人 = $請求:-顧客:-振込依頼人
- 債権金額 = 合計($請求-:売掛.残高) 
	- 売掛.残高=他仕様参照
	- 補足：振込予定金額（必ずしも振込の予定金額と一致するとは限らない）

## U08B003 マッチング登録

- FB振込と振分を比較し、マッチしたものをFBマッチングTableに登録。
	- 理由：マッチングしたものをあとで入金データとして登録し、さらには債権の消込を行うため。
- FB振込と振分を比較し、複数したマッチものをFBマッチングエラーテーブルに登録。
	- 理由：自動消込できなかった分を、あとでユーザーが調べるため（[要求u08_002](/u08_002)）。
- FB振込と振分を比較し、マッチはしたが、同一振込だったものを抽出。
	- 理由：自動消込できなかった分を、あとでユーザーが調べるため（[要求u08_002](/u08_002)）。

詳細仕様

- 入力：部署コード、伝送日付
- データ更新方針:特記事項なし
- トランザクション単位:一括
- 前提条件：U08B002振分 が完了していること。

### $マッチング結果を検索
FirmBankFurikomiSearchService#searchMatched

$マッチング結果 = (FB振込ID & FB振分ID) 組合せ

FB振込Table と 振分Tableを突合し、下記条件に合致するものを$マッチング結果として抽出する。

- FB振込.金額 = 振分.債権金額
- FB振込.依頼人名 = 振分:-振込依頼人.依頼人名
- FB振込.(銀行コード+口座番号) = 入力.部署:-部署銀行口座(銀行コード+口座番号)
- FB振込.伝送日付=入力.伝送日付

### $マッチング結果から$正常マッチングを取得
FBFurikomiMatchingResult#getMatchedNormally

- $正常マッチング = $マッチング結果から$マッチングエラーを除去
- $マッチングエラー = $複数マッチング振分 + $同一振込

### $マッチング結果から$複数マッチングを取得
FBFurikomiMatchingResult#getMultipleMathed

- 1つの$FB振込に対してマッチする振分の件数が2つ以上

### $マッチング結果から$同一振込を抽出
FBFurikomiMatchingResult#getRepetition

- 1つの$請求に対してマッチする$FB振込の件数が2つ以上
- $請求 = $マッチング結果.振分:-請求

### $正常マッチングをマッチングTable登録
FirmBankFurikomiMatchingCrudService#save

- 振込ID=$正常マッチング.FB振込ID
- 振分ID=$正常マッチング.振分ID

### $マッチングエラーをマッチングエラーTableに登録
FirmBankFurikomiMatchingErrorCrudService#save

- 振込ID=$マッチングエラー.FB振込ID
- 原因=複数マッチングor同一振込

## U08B003 アンマッチ登録

FB振込と振分を比較し、マッチングしないもの（アンマッチFB振込）をFBマッチングエラーTableに登録。

処理仕様

- 入力：伝送日付
- データ更新方針:特記事項なし
- トランザクション単位:一括
- 前提条件：U08B003マッチング登録が完了していること。

### FB振込Table から$アンマッチFB振込を検索
FirmBankFurikomiSearchService#searchUnmatched

- 伝送日付=入力.伝送日付
- マッチングテーブルに登録されていない
- マッチングエラーテーブルに登録されていない

### マッチングエラーTable 登録
FirmBankFurikomiMatchingErrorCrudService#save

- FB振込ID=$アンマッチFB振込.FB振込ID
- 原因=マッチングなし

## U08B004 入金

マッチング済FB振込を入金する。

処理条件

- 入力:伝送日付
- データ更新方針:特記事項なし
- トランザクション単位:一括
- 前提条件：U08B003 マッチング登録を完了していること。

### FB振込Table から$マッチング済FB振込リストを検索
MatchedFBFurikomiSearchService#search($伝送日付)

- 伝送日付=入力.伝送日付
- マッチングテーブルに登録されている

### $マッチング済FB振込を入金登録
NyukinFBFurikomiCrudService#save($マッチング済FB振込)

- 入金Table に登録
	- 部署=$マッチング済FB振込.請求.担当部署
	- 顧客=$マッチング済FB振込.請求.顧客
	- 金額=$マッチング済FB振込.金額
	- 入金日=$マッチング済FB振込.請求.担当部署.営業日
- 入金FB振込Table に登録

## U08B005 自動消込

マッチング済FB振込による入金で売掛の消込を行う。

処理条件

- 入力:伝送日付
- データ更新方針:特記事項なし
- トランザクション単位:一括
- 前提条件：U08B003マッチング登録とU08B004入金が完了していること。

### FB振込Table から$マッチング済FB振込を検索
MatchedFBFurikomiSearchService#search($伝送日付)

- 伝送日付=入力.伝送日付
- マッチングテーブルに登録されている

### $入金消込を構築
NyukinKeshikomiBuildService#build($マッチング済FB振込)

- 入金=$マッチング済FB振込と紐づく入金
- 消込
	- 売掛=$マッチング済FB振込と紐づく$売掛
	- 消込日=$部署営業日
	- 金額=$売掛金残高
- 補足
	- $請求担当部署=$マッチング済FB振込.請求.担当部署
	- $部署営業日=$請求担当部署.営業日
	- $売掛金残高=売掛消込仕様サービス#現在残高取($売掛)

### $入金消込の整合性検証
NyukinKeshikomiValidateService#validate($入金消込)

エラー条件
- 消込.金額 < 0 
- 消込.金額の合計 > 入金.金額
- 消込.金額 > 売掛.残高
- 1つの売掛への消込が2つ以上存在する（同一消込日に同じ売掛が二回消し込まれている）

### 消込テーブル登録
NyukinKeshikomiCrudService#save($部署営業日, $入金消込)

# [u08005] 自動消込対象とならなかった振込（振分マッチングエラー）を一覧化する。

- 自動消込できなかった振込を、ユーザーが手動で消込むのに選択するため。
