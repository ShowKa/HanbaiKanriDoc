ULTRA仕様

請求書処理
・お客様から依頼があれば再作成。
　→ おそらく売上登録の内容が間違っている場合、売上を修正した上で再作成。
・未請求かつ締め日到来の売上のみ請求対象となる
　→前月未振込分は？
・口振の請求書は異なる（「口振のお知らせ」という書類になる）
　→ これだけで、請求書作成より複雑な業務が必要？
・臨時掛売処理
　→ たぶん販売区分=現金の顧客に対して行う。

FB消込処理
下記の内容でFB自動消込されていた。
・売掛金=11,340円（10,500円+消費税8%）
・FB=入金額=10,692円
・入金消込額=10,692円, 手数料=648円 → 消込額=11,340円
　→ この648円はなにものか（入金された瞬間にひかれる手数料？振込手数料とは別？）

※クレジット、FBの場合手数料が取られる模様。
※集金の消込では手数料は考えなくてよい。

FB自動消込のマッチング条件
振込金額が以下の値のいずれかと合致したらマッチングOK（上から優先）
①債権額
②債権額－過剰入金額
③債権額－過剰入金額－振込手数料
④債権額－振込手数料

※振込手数料マスタというものが存在する。
※④でマッチングできた場合、
　振込金額=10,692円
　入金消込金額=10,692円, 手数料=648円で、売掛金=11,340円を消込処理する。

摘要額
貸倒などで、入金ないけど、消し込む必要があるときに行う。
あとは入金額が少しだけ不足している場合、雑損失としてしまう場合もある。

消込取消
過去計上日の消込をなかったことにしたい場合、赤伝票的に消込取消レコードができる。
ただし、テーブルはおなじ「債権消込テーブル」にできる（売上と同じで赤黒混合）
また、取消した消込金額は、未処理金でなく、未処理金（修正分）に移動する。
→ 未処理金じゃないので、通常の手順だと、別の売掛の消込には充てられない。

入金消込で入金額が足りない場合（不足が1000円を超える場合）
(1) 雑損失として、計上する。
(2) 繰越金として納品先に再請求（こちらが基本ルール）

課題
売上訂正された場合（赤伝票）の消込はどうするのか？

■マッチング処理の流れ
U08B024→009→010→007→002
※024はファイルからFBデータをDBに突っ込むだけ

ーーーーーーーーーーーーーーーーーーーーーー
■U08B009 FB振分データ作成
ーーーーーーーーーーーーーーーーーーーーーー
振込人、納品先、売上、請求、債権消込→FB振分用HDR&DTL
HDR - 入金元の請求額（合計）
DTL - 上記の請求ごと（=納品先部署毎ごと）の金額の明細

※ 請求SEQは、納品先部署毎ごとに発行される
※ 請求テーブルからは「請求締め日」「前回の請求締め日」を取得する。

(1)	FB振分用HDR、FB振分用DTLテーブルを全件削除する。
(2)	以下の条件で売上HDRを抽出する。
	条件：
		請求書作成済
		伝票区分が手伝掛売、HT掛売、受注自動
		債権残高≠0
		貸倒となっていない
(3)	抽出した売上HDR、請求、納品先（部署毎）、振込人名を結合し、
	前回請求締日から今回請求締日までの
	売掛金残高を、入金元コード>請求締日前回>請求締日今回>請求SEQ>
	振込人名カナ>部署コード>納品先コード毎に債権額（売掛金残高）集計し、
	振込人名（複数設定あり）の組み合わせで展開したデータを作成して、
	FB振分用DTLに追加する。

→ 基本的に未入金の債権は改めて請求され直すので、今回請求締日はひとつになる？?

(4)	FB振分用DTLの債権額を、入金元、請求締日、振込人名で集計し、
	FB振分用HDRに追加する。

ーーーーーーーーーーーーーーーーーーーーーー
■U08B010 FB自動振分
ーーーーーーーーーーーーーーーーーーーーーー
1.既存データ削除
FBマッチングHDR(振込毎)、FBマッチングDTL（部署・納品先毎）
のレコード全件を削除する。

2.FBデータチェック処理
FBデータHDR、FBデータDTL、FB振分用HDR、FB振分用DTL
を読み込み、以下の条件のどれかに合致した場合は、エラーとして
FBマッチングHDRを出力する。
(1)	FBデータDTLの入払区分が"入金"　かつ　取引区分が
	（"振込" または "訂正"）以外
(2)	FBデータDTLの入払区分が"出金"　
(3)	FBデータDTLの振込依頼人がNull　かつ 摘要内容がNull
(4)	FBデータDTLの口座情報を基に入金元担当部署を取得し、
	同一部署内に同一振込依頼人名が複数存在する場合。

3.振分用データマッチング処理
FBデータDTLとFB振分用HDRをマッチングし、以下の条件のどれかに
合致した場合は、エラーとしてFBマッチングHDRを出力する。
マッチングキー：入金元担当部署＞振込依頼人名
(1)	FBデータDTLとマッチするFB振分用HDRが存在しない
(2)	FBデータDTLとマッチするFB振分用HDR内に、複数の入金元が混在

4.取引金額マッチング処理
FBデータの取引金額とFB振分用HDRのマッチングを行う。
マッチングキー：入金元担当部署＞振込依頼人名＞金額
※金額の比較は以下の優先順で行う。
	（一致する金額がワークに存在しない場合）
	①債権額
	②債権額－過剰入金額
	③債権額－過剰入金額－振込手数料
	④債権額－振込手数料

マッチしない場合は、エラーとしてFBマッチングHDR及びDTLを出力する。
マッチした場合は、正常データとしてFBマッチングHDR及びDTLを出力する。

ーーーーーーーーーーーーーーーーーーーーーー
■U08B007 振込データ作成（入金）
ーーーーーーーーーーーーーーーーーーーーーー
1. 口座情報突き合わせ
 (1) FBデータを抽出する。
 (2) FBデータDTLの持つ口座情報と、部署の持つ口座情報の突き合わせを行う。

2. 振込データ作成

 紐づく口座情報が存在する場合、
  (1) FBデータを基に振込に登録する。
  (2) 入金データ作成（U08C004）
   入金データ作成（振込）ロジックの「入金データ作成」処理を実行することにより行う。
  (3) FBデータDTL更新
   処理済フラグ及び「部署アンマッチフラグ」を更新する。

 紐づく口座情報が存在しない場合、
  (1) FBデータDTL更新
   処理済フラグ及び「部署アンマッチフラグ」を更新する。

3.メッセージ通知
 紐づく口座情報が存在しないFBデータが存在した場合、
 FBデータの件数をメッセージ通知に登録する。

◇U08C004

1. 入金データ作成
 振込テーブルからデータを抽出し、入金（振込）に登録する。
 (1) 入金データ未作成の振込データを抽出する。
  条件：入払区分＝"入金"　かつ 入金データ未作成
　→　納品先コードはFBマッチングHDRｙとり引っ張る（マッチング成功してないと、入金データは作成されないってこと）
 (2) 抽出した振込データから入金（振込）データに登録する。

2. 他部署振替データ作成
 他部署連携分を含む入金の場合は、他部署振替データを作成する。
 (1) FBマッチングHDR及びFBマッチングDTLから、入金元部署と納品先担当部署
  が異なる（他部署連携分）データを抽出する。
 (2) 抽出したデータから部署毎の金額を求め、他部署振替に登録する。
 (3) U08C002：入金データ作成（他部署振替）を呼び出す。
  ※パラメータ.振替SEQ＝上記(2)で登録した他部署振替.振替SEQ

ーーーーーーーーーーーーーーーーーーーーーー
■U08B002 FBデータ自動消込
ーーーーーーーーーーーーーーーーーーーーーー
FBマッチングデータを参照し、債権管理担当部署毎に、FB入金に伴う入金データ（振込、他部署振替）から、債権の自動消込を行う。

※消込元入金
　入金元部署
　連携部署

○ 各処理の概要
 1. 消込対象債権抽出
自動消込を行う消込情報（FBマッチングDTL(部署・納品先毎)）、債権（売上HDR）を抽出する。
(1) FBマッチングHDR(振込毎)の対象条件
 条件：自動消込処理済フラグ="0"（未処理）

 2. 債権自動消込
(1) FBマッチングHDR(振込毎)．エラーコード="F00"（エラー無し）の場合
 FBマッチングDTL(部署・納品先毎)を基に、抽出した債権（売上HDR）毎に順次消込処理を行う。
 　※消込元優先順：振替手数料＞過剰入金＞入金の未処理金
 　※債権処理順：担当部署コード＞請求SEQ
(2) U08C003自動消込ロジックを呼び出す。
 (a) 消込元残高、売上HDRの売掛金残高から消込金額を算出
 (b) 消込金額で債権消込データを追加
 (c) 売上HDR、納品先残高の売掛金残高から消込金額を減算
 (d) 消込元の残高（納品先残高の過剰入金または入金の未処理金）を減算
(3) FBマッチングHDR(振込毎)と入金を処理済に更新する
